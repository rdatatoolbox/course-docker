<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Introduction à Docker</title>
    <meta charset="utf-8" />
    <meta name="author" content="  Nicolas CASAJUS .inst[{{ Data scientist FRB-CESAB }}]" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/font-awesome-5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="libs/font-awesome-5.15.3/css/v4-shims.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="css/custom.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: right, middle, title-slide

# Introduction à Docker
## <i>the hardest part </i> <i class="fa fa-meh-rolling-eyes" role="presentation" aria-label="meh-rolling-eyes icon"></i>
### <br /><br />Nicolas CASAJUS<br />.inst[{{ Data scientist FRB-CESAB }}]
### .inst[Jeudi 2 décembre 2021]

---



class: inverse, center, middle

## C'est parti !

&lt;br /&gt;

![](img/ahhhh.gif)

---

## Il était une fois...

--

**... un étudiant qui a passé plusieurs mois à analyser ses données. Comme il a tout
compris à la vie, il travaille sous GNU/Linux. Son code est complexe et repose sur
de nombreux logiciels et librairies système. Arrive le temps de partager son code avec
ses collaborateurs. Mais, un de ses collaborateurs le contacte en lui disant que son code
ne fonctionne pas. Ce dernier est sous Windows (_no comment_). Après plusieurs
tentatives, il apparait que cela n'a rien à voir avec le code : c'est un problème
d'environnement de travail.**

--

Que faire <i class="fa fa-question-circle dark" role="presentation" aria-label="question-circle icon"></i>


.center[![](img/noidea.gif)]

---

## Option 1


<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Ecrire des tutoriels pour
chaque OS (et version d'OS) pour installer toutes les dépendances système requises
pour que le code fonctionne à peu près n'importe où

--

  &gt; **Mouais, bof...**
  &gt;
  &gt; J'ai autre chose à faire. En plus, j'ai pas accès à tous les OS...
  &gt;
  &gt; Et quid des futurs OS ?

---

## Option 2 - Virtualisation

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Fixer le type d'OS (et
sa version) et utiliser une machine virtuelle dans lequel il s'exécutera

.center[![:scale 75%](img/vm.png)]

--

C'est une solution qui marche et qui est encore utilisée.

--

Le collaborateur devra alors :

1. Installer un logiciel de virtualisation (par ex. Oracle Virtual Box)
2. Télécharger l'ISO de l'OS (par ex. Ubuntu Focal Fossa 20.04 LTS)
3. Installer l'OS dans la machine virtuelle
4. Configurer la machine virtuelle (création de volumes de persistence)
5. Télécharger et configurer toutes les dépendances
6. Lancer le projet dans l'OS virtualisé

--

**N.B.** Certaines étapes peuvent être automatisées (par ex. avec [**Vagrant**](https://www.vagrantup.com/))

---

## Option 2 - Virtualisation

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Problèmes :
1. c'est compliqué à mettre en place,
1. c'est lourd (plusieurs Go juste pour l'OS et les dépendances),
1. c'est gourmand en ressources (RAM, CPU).


---

## Option 3 - Conteneurisation

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;**Solution :** 
s'orienter vers des solutions de **conteneurisation** telles que 
[**Docker**](https://www.docker.com/) &amp;nbsp; <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>

&lt;br /&gt;&lt;br /&gt;

![](img/docker.png)


---

## Virtualisation


![](img/versus-1.png)

---

## Virtualisation _vs._ Conteneurisation


![](img/versus-2.png)


--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;**Avantages de la conteneurisation :**

- Extrêmement léger (exploitation du noyau Linux)
- Utilisation réduite de ressources (RAM, CPU)
- Partage des ressources ente les instances
- Déploiement simple et instantané


---

## Docker en bref

.center[![:scale 75%](img/docker.png)]

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Plateforme open source permettant de :

- empaqueter une application avec toutes ses dépendances système
- partager facilement un environnement de travail complet
- déployer rapidement une application en production

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Un conteneur est _isolé_ du système hôte : Docker permet donc de :

- tester des choses sans crainte d'endommager son système hôte
- garder son système hôte propre, en installant tout sur Docker
- utiliser différentes versions d'une librairie, d'un serveur, etc.

--

<i class="fa fa-exclamation-triangle dark" role="presentation" aria-label="exclamation-triangle icon"></i> &amp;nbsp;Idéal pour créer un environnement
de developpement (basé sur Linux)

---

## La notion d'Image

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Ca a l'air super, mais concrètement, comment je crée un conteneur <i class="fa fa-question-circle dark" role="presentation" aria-label="question-circle icon"></i>

--


Tout conteneur est basé sur une image que l'on crée soi-même ou qu'on récupère depuis un site d'archivage (comme le CRAN pour <i class="fab fa-r-project" role="presentation" aria-label="r-project icon"></i>)

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Une **image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>** est une sorte de conteneur figé : c'est un template **fixe** (une recette de cuisine) à partir duquel on créera un
ou des conteneurs. Une image est `immuable`.

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Un **conteneur <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>** est donc une instance (exécution) d'une image qui pourra être utilisée/modifiée une fois créée


---

## La notion d'Image

_Prenons un exemple tiré par les cheveux._

--

_Quand je lance RStudio (équivalent à une image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> dans notre exemple),
j'ouvre une instance RStudio (équivalent, dans notre exemple, à un conteneur).
Si je clique une seconde fois sur l'exécutable de RStudio, j'ouvre une seconde
instance (un second conteneur) indépendante de la première._

_Tout ce que je fais dans la première instance n'est pas répercuté dans la seconde. Et vice versa._

_Plus important encore, ces modifications ne se répercutent pas dans l'exécutable de RStudio._

C'est la même logique avec les images et conteneurs <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>.


---

## Docker Hub

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Où trouver des images <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> ?
Sur un site d'archivage officiel [**Docker Hub**](https://hub.docker.com).
C'est une sorte de CRAN (publique) pour <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>.

![](img/docker-hub.png)

---

class: inverse, center, middle

## Installation de Docker

---

## Installation

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Docker s'installe sur GNU/Linux, et depuis peu, sur macOS et Windows 10 (installation différente selon l'édition, e.g. Home vs. Pro). Rendez-vous sur cette [**page **](https://docs.docker.com/get-docker/) et suivez les instructions.

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Une autre façon d'accéder
à Docker sans l'installer en local est d'utiliser la plateforme [**Play with Docker**](https://labs.play-with-docker.com/)
(identifiant Docker requis)

.pull-left[![](img/pwd.png)]

.pull-right[
C'est une plateforme qui donne accès à un serveur Alpine Linux sur lequel Docker et
d'autres utilitaires (git, serveur ssh) sont préinstallés.
La session dure 4h et on peut démarrer plusieurs instances.

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Durant l'exercice, on verra
comment récupérer les données depuis ce serveur (ssh _vs._ git).
]

---

## Play with Docker - Navigateur

![](img/pwd-1.png)

---

## Play with Docker - Accès SSH

![](img/pwd-2.png)


---

class: inverse, center, middle

## Création d'un conteneur

---


## Création d'un conteneur

![](img/workflow-1.png)


---

## Mon premier conteneur

**Je ne connais pas du tout GNU/Linux, mais j'aimerais bien l'essayer !**

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Qu'à cela ne tienne : nous allons télécharger une image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> de Debian.
Allons faire un tour sur [**Docker Hub**](https://hub.docker.com/search?q=debian&amp;type=image).

![](img/hub-search.png)

---

## Mon premier conteneur

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;On peut également chercher une image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>
depuis le terminal

```sh
docker search debian
```

```
NAME      DESCRIPTION                                       STARS   OFFICIAL
ubuntu    Ubuntu is a Debian-based Linux operating sys...   11465   [OK]
debian    Debian is a Linux distribution that's compos...   3635    [OK]
...       ...                                               ...
```

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour télécharger l'image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>, on peut lancer la commande suivante :

```sh
docker pull debian
```

<i class="fa fa-exclamation-triangle dark" role="presentation" aria-label="exclamation-triangle icon"></i> &amp;nbsp;Cependant, en procédant ainsi nous téléchargerons la dernière version de Debian.
Afin d'être reproductible, nous fixerons une version particulière (appelée **tag** sous <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>).

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Téléchargeons l'image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> de Debian 10 (appelée Buster).

```sh
docker pull debian:buster                            # ou, docker pull debian:10
```

---

## Mon premier conteneur

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Listons les images <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> présentes en local :


```sh
docker images                                        # ou, docker image ls
```

```
REPOSITORY      TAG         IMAGE ID          CREATED           SIZE
debian          buster      1510e8501783      2 weeks ago       114MB
```

--

&lt;br /&gt;

**Deux choses importantes sont à noter :**

1. Chaque image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> dispose d'un identifiant unique (**IMAGE ID**)
2. La taille de l'image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> **!!!**

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour supprimer une image :

```sh
docker rmi 1510e8501783
```

---

## Mon premier conteneur

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Créons notre conteneur, c'est-à-dire une
instance de notre image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>.

```sh
docker run -it debian:buster                  # ou, docker run -it 1510e8501783
```

--

&lt;br /&gt;

Notre prompt vient de changer :

```
root@ea8d63136eef:/#
```

--

&lt;br /&gt;

Nous sommes dans notre conteneur <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> !
Le prompt nous dit que nous sommes connectés en tant qu'utilisateur `root` sur
le conteneur dont l'identifiant est `ea8d63136eef` (différent de l'ID de l'image !)

--

Vous ne me croyez pas ?


```sh
cat /etc/issue
```

```
Debian GNU/Linux 10
```

---

## Mon premier conteneur

Revenons sur la commande `docker run -it debian:buster`

--

1. L'instruction `docker run` exécute une instance de l'image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> **debian** portant le tag **buster**.
Il faut noter que si cette image est absente de notre machine, alors <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> essaiera de la
télécharger depuis Docker Hub. Donc, cette commande fait également un `docker pull` si besoin est.

--

1. Le double drapeau `-it` indique que l'on souhaite interagir avec le conteneur.
En général, les images <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> ne contenant qu'un OS (pas d'application)
retournent toujours un shell (invite de commandes), mais pour y accéder, il faut demander
l'accès (avec le drapeau `-it`).

--

&lt;br /&gt;

Pour être certain d'interagir avec le shell, nous aurions pu indiquer la commande devant
être exécutée au lancement du conteneur (ici, `bash`, le shell par défaut sous Debian)

```sh
docker run -it debian:buster bash
```

---

## Mon premier conteneur

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Si jamais nous avions oublié le drapeau
`-it`, ce n'est pas grave. Nous avons toujours la possibilité de rentrer dans le conteneur avec :


```sh
docker exec –it ea8d63136eef bash
```

<i class="fa fa-exclamation-triangle dark" role="presentation" aria-label="exclamation-triangle icon"></i> &amp;nbsp;Lorsqu'on quitte le conteneur avec la commande
`exit`, celui-ci est stoppé si on est rentré dans le conteneur avec la commande `docker run`.
Mais il n'est pas stoppé si on a accédé au shell avec `docker exec bash`.

--

&lt;br /&gt;

Par défaut, Docker donne un nom aléatoire à un nouveau conteneur (notre conteneur
a été nommé `magical_lehmann`). Mais, on peut lui en attribuer un de notre choix
avec le drapeau `--name` :

```sh
docker run -it --name "debbie" debian:buster
```

---

class: inverse, center, middle

## Gestion des conteneurs


---

## Gestion des conteneurs

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour lister les conteneurs (processus) actifs :

```sh
docker ps
```

```
CONTAINER ID   IMAGE           COMMAND   CREATED     STATUS     PORTS   NAMES
ea8d63136eef   debian:buster   "bash"    2 min ago   Up 2 min           magical_lehmann
```

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour arrêter un conteneur :

```sh
docker stop ea8d63136eef                    # ou, docker stop magical_lehmann
```

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour démarrer un conteneur :

```sh
docker start ea8d63136eef                   # ou, docker start magical_lehmann
```

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour supprimer un conteneur :

```sh
docker rm ea8d63136eef                      # après un docker stop
docker rm -f ea8d63136eef                   # si le conteneur est actif
```


---

## Gestion des conteneurs

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Pour lister les conteneurs (processus) actifs et arrêtés :

```sh
docker ps -a
```

```
CONTAINER ID   IMAGE           COMMAND   CREATED     STATUS             NAMES
ea8d63136eef   debian:buster   "bash"    2 min ago   Up 2 min           magical_lehmann
178b8649b677   debian:buster   "bash"    9 hours ago Exited (0) 2s ago  debbie
```
--


<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Enfin, pour connaitre les ressources consommées par les conteneurs
actifs :

```sh
docker stats
```

```
CONTAINER ID   NAME              CPU %  MEM USAGE / LIMIT   MEM %
ea8d63136eef   magical_lehmann   0.00%  788KiB / 1.944GiB   0.04%
```

--

&lt;br /&gt;

<i class="fa fa-exclamation-triangle dark" role="presentation" aria-label="exclamation-triangle icon"></i> &amp;nbsp;Après un reboot de la machine, les conteneurs
actifs et stoppés existent toujours. Mais, ceux qui ont été supprimés avec `docker rm`, eux, n'existent plus.



---

class: inverse, center, middle

## Persistance


---

## Persistance des conteneurs

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i>&amp;nbsp; Mais si un conteneur est isolé,
comment je récupère mes données qui sont à l'intérieur ? Et, comment je donne accès aux
données stockées sur ma machine à mon conteneur ?

--
&lt;br /&gt;

En effet, un conteneur n'est pas persistant : tout ce qui est ajouté à l'intérieur (fichiers, logiciels, etc.)
n'est pas accessible depuis l'extérieur. Et lorsque celui-ci est détruit,
tout est perdu ! Ce qui est un avantage pour bidouiller le contenu, mais un inconvénient
lorsqu'on veut travailler sérieusement.

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i>&amp;nbsp; Pour les données, on créera des **volumes**

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i>&amp;nbsp; Pour les logiciels, on créera une nouvelle **image** <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>


---

## Volumes de persistance

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Un volume&lt;sup&gt;*****&lt;/sup&gt; est un dossier. L'idée est de créer un pont entre un dossier du conteneur et un dossier
de notre machine. On parle de **volumes mapping**

.footnote[
***** Ce n'est pas tout à fait vrai, et un volume peut avoir un autre sens avec Docker, mais faisons simple...
]
--

Ainsi, un fichier/dossier créé dans le volume de la machine sera accessible par le conteneur via
le volume lié. Et vice-versa.

Le volume local (celui sur la machine) sera persistant même après
la suppression du conteneur (et de son volume persistant).

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
C'est cela qu'on appelle la **persistance**


---

## Volumes de persistance

Soit le dossier `projet/`
présent dans mon dossier personnel (noté `~` sous Unix) de ma machine (macOS). Celui-ci contient le dossier
`data/`, un fichier `.csv` à l'intérieur et le fichier `README.md` :

```
projet
├── README.md
└── data
    └── data-1.csv
```

--

Je souhaite mapper ce volume à un dossier de mon **nouveau** conteneur, par ex.
le dossier personnel de l'utilisateur **root** : `/root/`

--


<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Pour cela, lorsque je créerai un nouveau conteneur basé sur l'image `debian:buster` avec
la commande `docker run`, je rajouterai le drapeau `--volume` (ou `-v`) de la manière suivante :

```sh
-v chemin_absolu_vers_dossier_local:chemin_absolu_vers_dossier_conteneur
```

--

<i class="fa fa-exclamation-triangle dark" role="presentation" aria-label="exclamation-triangle icon"></i> &amp;nbsp;
Les volumes mentionnés doivent exister tant sur la machine locale et dans le conteneur
et il faut mentionner le chemin absolu vers ces dossiers.

---

## Volumes de persistance

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Ce qui nous donne :

```sh
docker run -it --name "debbie" -v ~/projet:/root debian:buster
```

--
&lt;br /&gt;
Maintenant, si j'affiche le contenu du dossier `/root/` de mon conteneur

```sh
ls /root
```

```
README.md  data
```

```sh
ls /root/data/
```

```
data-1.csv
```

--
&lt;br /&gt;
Créons un second fichier `README-2.md` dans mon conteneur

```sh
echo "Cree dans le conteneur" &gt; /root/README-2.md
```

---

## Volumes de persistance

Vérifions qu'il a bien été créé depuis le conteneur :

```sh
ls /root
```

```
README-2.md  README.md	data
```

Affichons son contenu

```sh
cat /root/README-2.md
```
```
Cree dans le conteneur
```

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Qu'en est-il sur ma machine ?

```sh
tree ~/projet
```

```
projet
├── README-2.md
├── README.md
└── data
    └── data-1.csv
```


---

## Volumes de persistance

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Et si je supprime le conteneur, que deviendra mon dossier sur ma machine ?

--

```sh
docker stop debbie
docker rm debbie
```

--

```sh
tree ~/projet
```

```
projet
├── README-2.md
├── README.md
└── data
    └── data-1.csv
```

--

&lt;br /&gt;
<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Les données ont été persistées **!!!**


---

class: inverse, center, middle

## Création d'une image

---

## Ajout d'outils

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Que se passe-t-il si mon conteneur ne contient pas tous les outils (librairies, logiciels, etc.) dont j'ai besoin ?

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;**Option 1** : la méthode **sale**

L'idée est de rentrer dans un conteneur, d'installer les outils manquants (`apt-get install`) et
d'enregistrer le nouvel état du conteneur vers une nouvelle image (avec `docker commit`). A titre
informatif (uniquement) :

```sh
docker commit id_image nom_nouvelle_image
```

--

C'est **très très sale** : les outils sont installés à la volée (depuis le conteneur) et
on ne garde aucune trace des changements apportés. Niveau sécurité, c'est pas top... Et en plus,
on n'est pas à l'abri de faire des mauvaises manip' et de compromettre la future image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>

--

&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;**Option 2** : le `Dockerfile`

---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Le `Dockerfile` est la recette qui va
créer une nouvelle image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>

C'est un simple fichier texte (**sans extension**) qui fournit une suite d'instructions amenant
à la construction de la future image. Chaque instruction va créer une couche dans l'image (système de Lego) : plus
il y aura de couches, plus l'image sera lourde.

--

&lt;br /&gt;

De plus, il est rare de construire une image _from scratch_ : on se base très souvent
sur une (seule) image existante.

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Ainsi, le processus de création
d'une image est **incrémental** et peut être comparé à un `git pull`

Lors de la construction de l'image, si l'image de référence est présente sur la machine,
pas besoin de la télécharger (à l'instar, lors d'un `git pull`, on ne télécharge pas
l'ensemble de l'historique, juste les dernières modifications).


---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;**Objectif** : nous allons
améliorer l'image `debian:buster` en lui ajoutant quelques utilitaires manquants :

- `htop` : outil de monitoring du système
- `nano` : éditeur de texte simple en ligne de commandes
- `tree` : outil d'arborescence
- `wget` : programme de téléchargement de fichiers

--

Sur notre machine locale, nous allons créer un dossier, par ex. `mydebbie/`
dans lequel nous allons créer un fichier qu'on va nommer `Dockerfile` et
dans lequel nous écrire ces lignes.

--

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;
```

--

- La clause `FROM` permet de définir l'image de base (et sa version) sur laquelle on va bâtir
la nouvelle image.

- La clause `MAINTAINER` indique le créateur de l'image ainsi que le moyen de
le contacter.

---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Tel quel, ce `Dockerfile`
construira une image identique à l'image `debian:buster`

--

Rajoutons les instructions qui permettront d'installer les utilitaires requis

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

RUN apt-get update -yq
RUN apt-get install -yq --no-install-recommends htop nano tree wget
```
--

- La clause `RUN` permet de passer des commandes Linux classiques. Elle ajoute
une couche supplémentaire à notre image, ce qui l'alourdi. Il est donc
recommendé de limiter ces clauses et de les fusionner.

--

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget
```


---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
On peut réduire encore la taille de la future image en supprimant le cache du gestionnaire
`apt` qui contient les archives des utilitaires téléchargés.

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/
```

---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Nous pouvons aussi créer un répertoire avec la commande Unix `mkdir`

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/ \
  &amp;&amp; mkdir -p /root/data
```
---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Améliorons encore notre recette en définissant le répertoire par défaut
du conteneur, par ex. `/root/data` (celui dans lequel on se retrouvera lorsqu'on rentrera dans le
conteneur) avec la clause `WORKDIR`

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/ \
  &amp;&amp; mkdir -p /root/data

WORKDIR /root/data
```
---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
J'ai du écrire deux fois `/root/data` : en programmation, c'est jamais bon...
Heureusement, Docker offre la possibilité de manipuler des variables
d'environnement avec la clause `ENV`. Optimisons donc le code.

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

ENV FOLDER="/root/data"

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/ \
  &amp;&amp; mkdir -p "$FOLDER"

WORKDIR "$FOLDER"
```
---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Je voudrais copier un fichier que j'ai en local (et dans le même dossier dans l'exemple) dans l'image,
afin qu'il soit présent dans mes futurs conteneurs. Pour cela, j'ai la clause
`COPY`

```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

ENV FOLDER="/root/data"

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/ \
  &amp;&amp; mkdir -p "$FOLDER"

COPY README.md "$FOLDER"

WORKDIR "$FOLDER"
```

---

## Création d'image - Dockerfile

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Finalement, je peux aussi définir une commande par défaut qui sera exécutée lors
du lancement d'un conteneur. Ici, ouvrons un shell `BASH`


```docker
FROM debian:buster

MAINTAINER Nicolas Casajus &lt;nicolas.casajus@fondationbiodiversite.fr&gt;

ENV FOLDER="/root/data"

RUN apt-get update -yq \
  &amp;&amp; apt-get install -yq --no-install-recommends htop nano tree wget \
  &amp;&amp; apt-get clean \
  &amp;&amp; rm -rf /var/lib/apt/lists/ \
  &amp;&amp; mkdir -p "$FOLDER"

COPY README.md "$FOLDER"

WORKDIR "$FOLDER"

CMD ["bash"]
```

La clause `CMD` s'écrit toujours sous la forme d'un array (une sorte de liste) :
`CMD ["executable", "param1", "param2", "..."]`

---

## Le .dockerignore

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Tout comme <i class="fab fa-git" role="presentation" aria-label="git icon"></i>
et <i class="fab fa-r-project" role="presentation" aria-label="r-project icon"></i>, <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> est capable d'ignorer certains
fichiers/dossiers lors de la construction d'une image grâce à un `.dockerignore`

Cela est particulièrement important lorsque la clause `COPY` copie des dossiers entiers.

--

&lt;br /&gt;
Etant sous macOS, je vais ignorer les fameux fichiers `.DS_Store` et pourquoi pas les fichiers
et dossiers cachés de <i class="fab fa-git" role="presentation" aria-label="git icon"></i> (ça grossirait l'image pour rien)

```sh
echo ".DS_Store" &gt; .dockerignore
echo ".git" &gt;&gt; .dockerignore
echo ".gitignore" &gt;&gt; .dockerignore
```


---

## Build de l'image

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Nous sommes prêt pour construire (builder) notre image à partir du `Dockerfile`.
Pour cela, je vais utiliser la commande `docker build` avec le drapeau `-t` pour
donner un nom à mon image. Je dois aussi spécifier le répertoire contenant ma recette.
Ici, c'est le dossier dans lequel je vais lancer la commande, donc je peux écrire `.`

```sh
docker build -t buster .
```

--

Après quelques minutes, l'image est construite sur ma machine et a rejoint ma collection.

```sh
docker images
```

```
REPOSITORY          TAG           IMAGE ID            CREATED             SIZE
buster              latest        dd48c15a9389        46 minutes ago      121MB
debian              buster        1510e8501783        2 weeks ago         114MB
```

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Ma nouvelle image est légèrement plus grosse que celle d'origine : nous n'avons pas abusé des clauses `RUN`.

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Par défaut, la tag `latest` a été ajouté à la nouvelle image.


---

## Utilisation de l'image

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Nous revoilà revenu au point de départ. Mais,
avec une toute nouvelle image, faite maison qui plus est ! Créons-nous un conteneur pour l'fun

```docker
docker run -it --name "buster-1" buster
```

--

&lt;br /&gt;

Et tapons quelques commandes :

```sh
pwd                                          # Répertoire de travail
```

```
/root/data
```

--

&lt;br /&gt;

```sh
tree ../                                     # Utilisation du nouvel utilitaire
```

```
.
└── data
    └── README.md
```

---

## Résumé...

![](img/workflow-2.png)

---

## Résumé...

![](img/workflow-3.png)

---

## Résumé...

![](img/workflow-4.png)

---

## Résumé...

![](img/workflow-5.png)

---

## Résumé...

![](img/workflow-6.png)

---

## Résumé...

![](img/workflow-7.png)


---

class: inverse, center, middle

## Partage d'une image

---

## Publier sur le Docker Hub

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Nous allons voir qu'il est facile de publier une image <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i> sur le
[**Docker Hub**](https://hub.docker.com). Pour cela, il nous faut tout d'abord nous créer
un identifiant Docker en se rendant sur cette [**page**](https://hub.docker.com/signup).
Une fois créé, nous devons stocker notre Docker ID sur notre machine local grâce
à la commande suivante (nous devrons saisir l'ID et son mot de passe)

```docker
docker login
```

--
&lt;br /&gt;

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Nous allons déposer notre image sur Docker Hub dans notre repository personnel (publique).
Cependant, nous avons un problème, car pour ce faire, le nom de notre image doit
contenir notre identifiant Docker : `docker_id/image`.

Pas de soucis : nous n'avons qu'à créer une nouvelle image à partir de notre
`Dockerfile`. Comme elle sera identique, cela prendre 1s.

```docker
docker build -t nicolascasajus/buster .
```

---

## Publier sur le Docker Hub

Vérifions :

```docker
docker images
```

```
REPOSITORY              TAG        IMAGE ID         CREATED          SIZE
buster                  latest     b389eba1f1c9     2 hours ago      121MB
nicolascasajus/buster   latest     b389eba1f1c9     2 hours ago      121MB
debian                  buster     1510e8501783     2 weeks ago      114MB
```

--

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Docker lui a attribué la version
`latest`. Pour publier sur le Hub, il est préférable de lui attribuer un autre tag,
plus parlant. Allons-y


```docker
docker tag nicolascasajus/buster nicolascasajus/buster:1.0
```

Vérifions :

```docker
docker images
```

```
REPOSITORY              TAG        IMAGE ID         CREATED          SIZE
nicolascasajus/buster   1.0        b389eba1f1c9     2 hours ago      121MB
```


---

## Publier sur le Docker Hub

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
Il est temps de pusher !

```sh
docker push nicolascasajus/buster:1.0
```

---

## Publier sur le Docker Hub

![](img/my-hub-1.png)

---

## Publier sur le Docker Hub

![](img/my-hub-2.png)

---

## Publier sur le Docker Hub

![](img/my-hub-3.png)


---

## Publier sur le Docker Hub


![](img/workflow-7.png)

---

## Partager le Dockerfile

![](img/workflow-8.png)


---

class: inverse, center, middle

## <i class="fab fa-r-project" role="presentation" aria-label="r-project icon"></i> &amp; <i class="fab fa-docker" role="presentation" aria-label="docker icon"></i>


---

## Initiative Rocker

Si on se rappelle la définition d'un conteneur, celui-ci contient un environnement
de travail mais aussi, et surtout, une application. Or, il nous manque l'application.
Et idéalement, une application développée sous <i class="fab fa-r-project" role="presentation" aria-label="r-project icon"></i>...

--


<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
[**L'initiative Rocker**](https://www.rocker-project.org/)

.center[![:scale 80%](img/rocker.png)]

---

## Initiative Rocker

.center[![:scale 80%](img/rocker-img.png)]


<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;Ressources:&amp;nbsp;
[**GitHub**](https://github.com/rocker-org/rocker-versioned2) &amp;nbsp;|&amp;nbsp;
[**Docker**](https://hub.docker.com/r/rocker/r-ver)

---

class: inverse, center, middle

## Demo

&lt;br /&gt;

[**{sfrocker}**](https://github.com/ahasverus/sfrocker)


---

## Pour aller plus loin...

<i class="fa fa-hand-point-right dark" role="presentation" aria-label="hand-point-right icon"></i> &amp;nbsp;
[**Docker-compose**](https://docs.docker.com/compose/) - L'orchestrateur ultime


&lt;br /&gt;

.center[![:scale 80%](img/docker-compose.png)]
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="libs/macros.js"></script>
<script>var slideshow = remark.create({
"ratio": "4:3",
"highlightStyle": "zenburn",
"highlightLines": true,
"countIncrementalSlides": false,
"slideNumberFormat": "%current% / %total%"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
